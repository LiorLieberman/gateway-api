# GEP-2162: Supported features in GatewayClass Status

* Issue: [#2162](https://github.com/kubernetes-sigs/gateway-api/issues/2162)
* Status: Provisional

## TLDR

This GEP proposes to enhance the [GatewayClassStatus](https://github.com/kubernetes-sigs/gateway-api/blob/f2cd9bb92b4ff392416c40d6148ff7f76b30e649/apis/v1beta1/gatewayclass_types.go#L185) to include a list of gw-api features supported by the installed Gateway Class. 

## Goals

* Enable users easily see what features the implementation(gateway class) support
* Improving UX and potentially provide clear errors when a user is trying to use a feature the installed GWC doesn't support

## Non-Goals

* Validate correctness of supported features published by the implementation.

## Introduction

The current  [GatewayClassStatus](https://github.com/kubernetes-sigs/gateway-api/blob/f2cd9bb92b4ff392416c40d6148ff7f76b30e649/apis/v1beta1/gatewayclass_types.go#L185 is only used to store conditions the controller publishes.

With the evolution of the Conformance tests suite and features, we want to;

1. Enable users easily see what features the implementation support
1. Improve UX and potentially provide clear errors when a user is trying to use an unsupported feature

This doc proposes to enhance the GatewayClassStatus API so implementations could publish a list of features they support/don't support.

Implementations **should** publish the supported/unsupported features before Accepting the GatewayClass.

They can either maintain static lists of supported/unsupported features OR generate if from their conformance tests results/reports as part of their CI.

## API

This GEP proposes API changes describes as follow:
1. Adding `FeaturesSupport` and  `GatewayClassFeatures` structs. 
2. Update the `GatewayClassStatus` struct to include `GatewayClassFeatures`

```go
// FeaturesSupport contains the supported features and unsupported features by the installed GatewayClass.
type FeaturesSupport struct {
	// SupportedFeatures indicates which extended features were flagged as
	// supported by the implementation and tests will be attempted for.
	SupportedFeatures []string `json:"supportedFeatures,omitempty"`

	// UnsupportedFeatures indicates which extended features the implementation
	// does not have support for and therefore will not attempt to test.
	UnsupportedFeatures []string `json:"unsupportedFeatures,omitempty"`
}

// GatewayClassFeatures is the features supported by the GatewayClass broken down by support level.
type GatewayClassFeatures struct {
	// Core indicates the core support level features. UnsupportedFeatures should be null for the implementation to be considered all conformant. 
    Core FeaturesSupport `json:"core,omitempty"`

	// Extended indicates the extended support level features.
    Extended FeaturesSupport `json:"extended,omitempty"`
    
}
// GatewayClassStatus is the current status for the GatewayClass.
type GatewayClassStatus struct {
	// Conditions is the current status from the controller for
	// this GatewayClass.
	//
	// Controllers should prefer to publish conditions using values
	// of GatewayClassConditionType for the type of each Condition.
	//
	// +optional
	// +listType=map
	// +listMapKey=type
	// +kubebuilder:validation:MaxItems=8
	// +kubebuilder:default={{type: "Accepted", status: "Unknown", message: "Waiting for controller", reason: "Pending", lastTransitionTime: "1970-01-01T00:00:00Z"}}
	Conditions []metav1.Condition `json:"conditions,omitempty"`

    // Features is the features supported by the GatewayClass broken down by support level.
    Features GatewayClassFeatures `json:"features,omitempty"`
}
```

## Conformance Details

(TBD)

## Alternatives

### Re-using ConformanceProfiles structs

We could use the same structs as we do in conformance profile object, more specifically, the [ProfileReport](https://github.com/kubernetes-sigs/gateway-api/blob/main/conformance/apis/v1alpha1/profilereport.go#LL24C6-L24C19) struct.

Though it would be nice to have only one place to update, these structs seems to include much more data relevant to the conformance report but not for our use case. 

That said, conformance profiles are still at experimental stage, we could explore the option to create a shared struct that will be used both for the conformance reports and for the GatewayClass status.

### Instruct users to read from the future conformance profiles report

The current plan for conformance profiles is to also include centralized reporting. (specific details don't matter now)
We could wait for this to be implemented and instruct users to read from that source to determine what features their installed GatewayClass support.

This does not cover a future piece of work we want to implement which is to warn/block users from applying a gw-api object if the installed GWC doesn't support it. (originally suggested in [#1804](https://github.com/kubernetes-sigs/gateway-api/issues/1804)). 


## References

https://github.com/kubernetes-sigs/gateway-api/discussions/2108
https://github.com/kubernetes-sigs/gateway-api/issues/1804

## Future Work

### Develop an unsupported feature warning/blocking mechanism
Once the GatewayClass features support are is published into the status, we can use this to validate/warn/block offending configurations.

## Open Questions
N/A
